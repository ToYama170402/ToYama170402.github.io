+++
title = 'マイクラサーバーを立ててみた'
date = 2025-12-04T00:00:00+09:00
categories = ["ポエム","技術"]
draft = false
+++

# マイクラサーバーを立ててみた

この記事は[金沢IT部活 Advent Calendar 2025](https://qiita.com/advent-calendar/2025/kanazawa-itbukatsu)の4日目の記事になります（実際の投稿日が4日じゃないのはスンマセン…）。3日の記事は[りくと](https://qiita.com/rikut0904)さんの[オペレーティングシステムの勉強2-Linuxについて](https://qiita.com/rikut0904/items/5171e8ccea1a14833b37)でした。

唐突に生えたIT部活のアドカレを期に、溜まっていたネタを順々に放出できたらなと思います。

今回は身内向けにマイクラサーバーを構築した話から、構成やこだわりポイントなどを紹介していきます。マイクラサーバーの運営や監視周りは初めてで、AIと話しながら調べながらでやっていますので、生暖かい目で見ていってください。

## サーバーの構成

- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/)
- [Proxmox](https://proxmox.com/en/) (仮想化基盤)
- Docker
  - マイクラサーバー (PaperMC)
    - [DiscordSRV](https://modrinth.com/plugin/discordsrv) (Discord連携プラグイン)
    - [ViaVersion](https://modrinth.com/plugin/viaversion) (新しいクライアントで古いサーバーに接続できるようにするプラグイン)
    - [ViaBackwards](https://modrinth.com/plugin/viabackwards) (古いクライアントで新しいサーバーに接続できるようにするプラグイン)
    - [minecraft-prometheus-exporter](https://github.com/sladkoff/minecraft-prometheus-exporter) (Prometheusにメトリクスを送信するプラグイン)
  - [Bluemap](https://bluemap.bluecolored.de) (マイクラワールドマップツール)
  - [Prometheus](https://prometheus.io/) (監視基盤用時系列データベース)
  - [Grafana](https://grafana.com/ja/) (監視基盤ダッシュボード)

自宅の回線の都合で、ポートを開放して外部からアクセスすることができないのでCloudflare Tunnelを使っています。

DockerはProxmoxのKVMのマシン上で動作しています。Cloudflare Tunnelにトンネルを作るcloudflaredはProxmox上のLXCで動作しています。[cloudflaredはDockerでも動きますが](https://developers.cloudflare.com/cloudflare-one/networks/connectors/cloudflare-tunnel/downloads/)、DockerのKVMが倒れるとcloudflaredも巻き添えを食らってめんどくさいことになりそうだったので、分離してみています(この判断が良いのか悪いのかはわからないけど…)。

[Bluemapはマイクラサーバーのプラグインとしても動作します](https://bluemap.bluecolored.de/wiki/getting-started/Installation.html#using-bluemap-docker-image)がマイクラサーバーの動作に影響がありそうだったのと、マイクラサーバーが止まるとBluemapも止まってしまうので、マイクラサーバーとは分離してDockerコンテナで動かしています。

効果的なリソース配分や運用を楽しくするために、マイクラサーバーのメトリクス監視を手探りでやっています。minecraft-prometheus-exporterでマイクラサーバーのメトリクスを配信して、Prometheusからメトリクスを取得/保存して、Grafanaで可視化しています。やっぱりああいうダッシュボードってカッコいいよね。

// TODO: この辺にアーキテクチャ図を載せたい

## マイクラサーバーをDockerで立てるには

今回Dockerを使ってマイクラサーバーを構築したのですけど、思っていた以上に体験が良かったです。

僕の周りだと、やれビルドが面倒だの、やれJavaのバージョンが合わないだの、やれプラグインのバージョンが合わないだの、めんどくさいという文句をよく聞きました。しかしDockerイメージがよくできていたのでそのへんの不便さが払拭されていました。

今回使ったイメージは[itzg/minecraft-server](https://hub.docker.com/r/itzg/minecraft-server)というイメージです。[公式ドキュメント](https://docker-minecraft-server.readthedocs.io/en/latest/)にて丁寧に使い方が解説されています。

### 感動した機能

ここからはitzg/minecraft-serverを使っていて感動した機能について紹介します。

#### プラグインの宣言的な管理

itzg/minecraftには、docker-compose.ymlで環境変数の設定で任意のURLやModrinthやForgeからMODやプラグインをダウンロードして導入する機能があります。ちまちまとターミナルに貼り付けてダウンロードしてディレクトリに配置する手間が無くなって非常に便利でした。

#### バージョンの自動解決

itzg/minecraft-serverには、プラグインの対応しているマインクラフトサーバーのバージョンの共通しているものの中から最新のマインクラフトサーバーのバージョンを自動で選択する機能があります（Modrinthからダウンロードしたプラグインのみ）。バージョンが合わなくてプラグインが正常に動かないという状況が発生しにくくて良いです。

参考リンク：[Auto-download from Modrinth](https://docker-minecraft-server.readthedocs.io/en/latest/mods-and-plugins/modrinth/)

## 監視基盤

今回のサーバー構築で特に力を入れたのが、監視基盤です。使っているマシンがちょっと貧弱なので、前述した通り、定量的な指標から軽量化施策やリソース配分をできたら良いなと思って構築しました。サーバーがDockerで構築されているのでDocker周りの監視基盤も構築しましたがそれはまた別の記事にしようと思います。

[ナ組Minecraftサーバーの監視について —マイクラサーバー監視2020— ](https://blog.unasuke.com/2020/monitoring-minecraft-server/)を参考に[minecraft-prometheus-exporter](https://github.com/sladkoff/minecraft-prometheus-exporter)（以下exporter）を採用し、exporterのreadmeにそってPrometheusとGrafanaを設定しました。僕の環境だとPrometheusもDockerで動いているので、コンテナを同じネットワークに入れて`<コンテナ名>:9940`でアクセスするか、`host.docker.internal:9940`や`<DockerホストのIP>:9940`を使うことになります。同じネットワークに入れるのは面倒でややこしくなる上に、コンテナ名の衝突を避けるためにコンテナ名はDockerに自動でつけてもらうことにしているため、そもそもコンテナ名が変わってしまう可能性があります。そのため今回は`host.docker.internal:9940`でやりました。このためにわざわざポートを開けるのも微妙といえばそうなんですけどね。

今回minecraft-prometheus-exporterの導入で躓いたところは、exporterの設定ファイルで

```
host: localhost
port: 9940

```

と設定していたらPrometheusからexporterにアクセスできなかったことです。exporterはlocalhostで待っているので`host.docker.internal:9940`や`<DockerホストのIP>:9940`のアクセスは受け付けていません。なので

```
host: 0.0.0.0
port: 9940

```

と設定する必要がありました。これで無事にPrometheusからexporterにアクセスすることが出来ました。`0.0.0.0`と設定することで任意のアクセスを受け付けます。

## まとめ

Dockerを使ってマイクラサーバーを構築したという話でした。itzg/minecraft-serverでの構築体験が良かったこと、PrometheusとGrafanaでマイクラサーバーを監視したことについて説明しました。

